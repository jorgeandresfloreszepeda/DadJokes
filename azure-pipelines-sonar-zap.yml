trigger:
  branches:
    include:
    - main

pr:
  branches:
    include:
    - main

pool:
  vmImage: ubuntu-latest

variables:
  targetUrl: 'https://orange-pebble-0b3559310.1.azurestaticapps.net'

steps:
- checkout: self
  submodules: true
  persistCredentials: true
  fetchDepth: 0  # Importante para análisis de branches/PRs (descarga historial completo)

# Paso 1: Preparar análisis SonarCloud (CLI para JS/HTML simple)
- task: SonarCloudPrepare@3
  displayName: 'Preparar Análisis SonarCloud'
  inputs:
    SonarCloud: 'sonar_connector'  # Nombre exacto de tu service connection
    organization: 'jorgeandresfloreszepeda'     # Organization key de SonarCloud
    scannerMode: 'CLI'                   # CLI es ideal para proyectos JS/HTML sin build
    configMode: 'manual'
    ProjectKey: 'jorgeandresfloreszepeda_DadJokes'  # Project key exacto
    ProjectName: 'Chistes de Papá'    # Nombre amigable (opcional pero recomendado)
    cliProjectKey: 'jorgeandresfloreszepeda_DadJokes'
    cliSources: '.'                      # Raíz del repo (analiza todo)
    extraProperties: |
      sonar.qualitygate.wait: true
      sonar.qualitygate.timeout: 300

# Paso 2: Descargar el token desde Key Vault (tu paso existente)
- task: AzureKeyVault@2
  displayName: 'Obtener Deployment Token desde Key Vault'
  inputs:
    azureSubscription: 'azurerm-connection'
    KeyVaultName: 'kv-devsecops-2025'
    SecretsFilter: 'DeploymentToken'
    RunAsPreJob: false

# Paso 3: Ejecutar el análisis SonarCloud
- task: SonarCloudAnalyze@3
  displayName: 'Ejecutar Análisis SonarCloud'

# Paso 4: Publicar resultados y Quality Gate (opcional pero recomendado)
- task: SonarCloudPublish@3
  displayName: 'Publicar Resultados SonarCloud'
  inputs:
    pollingTimeoutSec: '300'  # Tiempo máximo de espera (5 min)
    continueOnError: false    # Evita que falle el pipeline si el Quality Gate falla

# Paso 5: Desplegar a Static Web Apps
- task: AzureStaticWebApp@0
  displayName: 'Desplegar a Azure Static Web Apps'
  inputs:
    app_location: '/'
    api_location: ''
    output_location: ''
    azure_static_web_apps_api_token: $(deploymenttoken)  # Ajustado a minúsculas si tu secreto es 'DeploymentToken'

# Paso 6: Ejecutar OWASP ZAP Baseline Scan (DAST)
- script: |
    mkdir zap-reports
    docker run --rm \
      -v $(Build.SourcesDirectory)/zap-reports:/zap/wrk/:rw \
      -t owasp/zap2docker-stable \
      zap-baseline.py \
      -t $(targetUrl) \
      -r zap-report.html \
      -x zap-report.xml \
      --autooff  # Apaga ZAP al finalizar
  displayName: 'Ejecutar OWASP ZAP Baseline Scan (DAST)'

# Paso 7: Publicar reportes ZAP como artefactos
- publish: $(Build.SourcesDirectory)/zap-reports
  artifact: 'OWASP-ZAP-Reports'
  displayName: 'Publicar Reportes OWASP ZAP'